/*
========================================================================================
    Nextflow Configuration File - arcasHLA Pipeline
========================================================================================
*/

// Global default params
params {
    // Input/Output options
    outdir                  = './results'
    samplesheet             = null

    // arcasHLA options
    hla_genes               = 'A,B,C,DMA,DMB,DOA,DOB,DPA1,DPB1,DQA1,DQB1,DRA,DRB1,DRB3,DRB5,E,F,G,H,J,K,L'
    threads                 = 8
    include_unmapped        = true  // Include unmapped reads in extraction
    
    // arcasHLA genotype options
    min_count               = 75        // Minimum count threshold
    max_count               = null      // Maximum count threshold (null = no limit)
    min_length_to_median    = 0.75      // Minimum length to median ratio
    max_length_to_median    = 1.25      // Maximum length to median ratio
    min_likelihood          = 0.0       // Minimum likelihood score
    drop_iterations         = 4         // Number of iterations for allele dropout
    drop_threshold          = 0.1       // Threshold for allele dropout
    zygosity_threshold      = 0.15      // Threshold for determining zygosity
    verbose                 = true      // Verbose output
    
    // Publishing options
    publish_dir_mode        = 'copy'

    // Module-specific config
    config_profile_name        = null
    config_profile_description = null

    // Max resource options
    max_memory              = '64.GB'
    max_cpus                = 16
    max_time                = '48.h'

    // Container options
    // Build the Docker image using: docker build -t arcashla:latest ./docker/
    // For GCP Artifact Registry: 
    // docker tag arcashla:latest us-docker.pkg.dev/your-project/arcashla/arcashla:latest
    // docker push us-docker.pkg.dev/your-project/arcashla/arcashla:latest
    arcashla_container      = 'us-docker.pkg.dev/ghobrial-pipelines/arcashla/arcashla:latest'
}

// Load module configurations
includeConfig 'conf/modules.config'

// Process settings
process {
    // Default container - uses arcasHLA Docker image
    container = params.arcashla_container

    // Error strategy
    errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries = 2
}

// Execution profiles
profiles {

    // Local execution profile (for testing)
    local {
        params.config_profile_name = 'Local'
        params.config_profile_description = 'Local execution profile for testing'

        docker {
            enabled = true
            runOptions = '-u $(id -u):$(id -g)'
        }

        process {
            executor = 'local'
            cpus = { check_max( 8 , 'cpus' ) }
            memory = { check_max( 32.GB * task.attempt, 'memory' ) }
            time = { check_max( 8.h * task.attempt, 'time' ) }
        }
    }

    // Google Cloud Platform profile
    gcp {
        params.config_profile_name = 'Google Cloud'
        params.config_profile_description = 'Google Cloud Platform execution profile'
        
        workDir = 'gs://ghobrial-pipelines/scratch'

        process {
            executor = 'google-batch'
            disk = '300 GB'
        }

        google {
            project = 'ghobrial-pipelines'
            region = 'us-central1'
            batch {
                spot = true
                maxSpotAttempts = 5
                bootDiskSize = '50 GB'
            }
        }

        docker {
            enabled = true
        }
    }

    // Standard profile (default)
    standard {
        params.config_profile_name = 'Standard'
        params.config_profile_description = 'Standard execution profile'

        docker {
            enabled = true
        }

        process {
            cpus = { check_max( 8, 'cpus' ) }
            memory = { check_max( 32.GB * task.attempt, 'memory' ) }
            time = { check_max( 8.h * task.attempt, 'time' ) }
        }
    }

    // Test profile (minimal resources)
    test {
        params.config_profile_name = 'Test'
        params.config_profile_description = 'Minimal test profile using arcasHLA test data'
        
        // Test-specific parameters
        params.samplesheet = "${projectDir}/test_data/samplesheet_test.csv"
        params.outdir = "${projectDir}/results_test"
        params.hla_genes = 'A,B,C,DPB1,DQB1,DQA1,DRB1'
        params.threads = 4
        params.include_unmapped = true
        params.verbose = true
        params.max_memory              = '8.GB'
        params.max_cpus                = 4
        params.max_time                = '48.h'
        docker {
            enabled = true
        }

        process {
            cpus = 4
            memory = 8.GB
            time = 2.h
        }
    }
}

// Function to ensure that resource requirements don't exceed limits
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max memory '${params.max_memory}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "   ### ERROR ###   Max time '${params.max_time}' is not valid! Using default value: $obj"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "   ### ERROR ###   Max cpus '${params.max_cpus}' is not valid! Using default value: $obj"
            return obj
        }
    }
}

// Manifest
manifest {
    name            = 'arcashla-pipeline'
    author          = 'Ghobrial Lab'
    homePage        = 'https://github.com/ghobriallab/nextflow-arcashla'
    description     = 'HLA typing pipeline using arcasHLA'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.0'
    version         = '1.0.0'
}

// Trace and report options
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_timeline.html"
    overwrite = true
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_report.html"
    overwrite = true
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/execution_trace.txt"
    overwrite = true
}
